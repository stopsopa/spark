<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Ajax</title>
</head>
<body>
    <pre></pre>

    <script src="/libs/onAllFinished.js"></script>
    <script src="/libs/jquery.js"></script>
    <script>
//        window.XMLHttpRequest.prototype.onAllFinished(function (status) {
//            log('onAllFinished', status)
//        }, 1000, 3000);

        var log = (function () {try {return console.log}catch (e) {return function () {}}}());

        function trim(s) {
            return s.replace(/^\s*(\S*(\s+\S+)*)\s*$/,'$1');
        }

        var ajaxN = (function () {
            'use strict';
            function createXHR() {
                if (window.XDomainRequest) return new XDomainRequest();     // code for IE7+, Firefox, Chrome, Opera, Safari
                if (window.XMLHttpRequest) return new XMLHttpRequest();     // code for IE7+, Firefox, Chrome, Opera, Safari
                if (window.ActiveXObject)  return new ActiveXObject("Microsoft.XMLHTTP");  //   code for IE6, IE5
                throw "Can't create xhr object";
            };
            return function (url, data) { // https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS
                return new Promise(function (resolve, reject) {
                    var xhr  = createXHR();
                    xhr.open('GET', url, true);
                    xhr.setRequestHeader('Content-type', 'text/plain'); // for ie9 issue
                    xhr.onreadystatechange = function() {
                        if (xhr.status === 0) {
                            xhr.abort();
                            reject('Server not found');
                            return;
                        }
                        if (xhr.readyState == 4)   {
                            if (xhr.status  == 200) {

                                var resp = xhr.responseText;

                                try {
                                    resp = JSON.parse(xhr.responseText);
                                }
                                catch (e) {
                                }

                                xhr=null;
                                resolve(resp);
                            }
                            else {
                                reject('Error status code: ' + xhr.status);
                            }
                        }
                    }
                    xhr.send(JSON.stringify(data || {}));
                });
            };
        })();

        function ajaxJ(url, data) {
            return $.ajax(url, {
                type: 'get',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(data)
            });
        }
        function ajaxF(url, data) {
            return fetch(url, {
                method: 'get',
                headers: new Headers({
                    'Content-type' : 'application/json; charset=utf-8'
                }),
                body: JSON.stringify(data)
            });
        }

        var ajaxD = (function () {

            var lib = function (delay) {

                (typeof delay === 'undefined') && (delay = 100);

                return new Promise(function (resolve) {
                    setTimeout(resolve, delay);
                });
            };

            lib.reject = function (delay) {

                (typeof delay === 'undefined') && (delay = 100);

                return new Promise(function (resolve, reject) {
                    setTimeout(reject, delay);
                });
            }

            return lib;
        }());

        document.addEventListener('DOMContentLoaded', function () {

            var pre = document.querySelector('pre');

            var query = (function () {
                var t, tmp = {};
                location.search.replace(/^\?(.*)$/, '$1').split(/&/g).map(function (a) {
                    t = a.split(/=/g);
                    t[1] = t[1] ? decodeURIComponent(t[1]) : true;
                    if (typeof tmp[t[0]] === 'undefined') {
                        tmp[t[0]] = t[1];
                    }
                    else {
                        if (typeof tmp[t[0]] === 'string') {
                            tmp[t[0]] = [tmp[t[0]], t[1]];
                        }
                        else {
                            tmp[t[0]].push(t[1]);
                        }
                    }
                });
                return tmp;
            }());

            if (query.tape) {

                var stack = [];

                ajaxN('/test/ajax/' + query.tape + '.txt')
                    .then(function (data) {

                        data = data.split(/\n/g).filter(function (d) {
                            return !!trim(d);
                        }).map(function (d, t, i) {
                            t = {}, i = 0;
                            d.replace(/([^\s]+)/g, function (r) {
                                t[(i++ === 0) ? 'm' : 'url'] = (/^\d+$/.test(r) ? parseInt(r, 10) : r);
                            });
                            return t;
                        });

                        (function run(t, m, u) {

                            t = data.shift();

                            if (t) {

                                m = 'ajax' + t.m.toUpperCase();

                                u = t.url;

                                if (typeof u === 'string') {
                                    u += '?' + m;
                                }

                                stack.push(t);

                                pre.innerHTML = JSON.stringify(stack, null, '    ');

                                window[m](u).then(run)
                            }
                        }());

                    })
            }
        });

    </script>
</body>
</html>