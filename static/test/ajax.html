<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Ajax</title>
    <style>
        * {
            background-color: #2E2E2E;
            color: #DEDEDE;
            font-size: 11px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <pre id="json">/test/ajax.html?tape=test</pre>
    <pre id="other"></pre>

    <script src="/libs/onAllFinished.js"></script>
    <script src="/libs/jquery.js"></script>
    <script>

        var log = (function () {try {return console.log}catch (e) {return function () {}}}());

        function trim(s) {
            return s.replace(/^\s*(\S*(\s+\S+)*)\s*$/,'$1');
        }

        var ajaxN = (function () {
            'use strict';
            function createXHR() {
                if (window.XDomainRequest) return new XDomainRequest();     // code for IE7+, Firefox, Chrome, Opera, Safari
                if (window.XMLHttpRequest) return new XMLHttpRequest();     // code for IE7+, Firefox, Chrome, Opera, Safari
                if (window.ActiveXObject)  return new ActiveXObject("Microsoft.XMLHTTP");  //   code for IE6, IE5
                throw "Can't create xhr object";
            };
            return function (url, data) { // https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS
                return new Promise(function (resolve, reject) {
                    var xhr  = createXHR();
//                    xhr.open((url.indexOf('/delay') === 0) ? 'POST' : 'GET', url, true);
                    xhr.open('GET', url, true);
//                    xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8'); // for ie9 issue
                    xhr.onreadystatechange = function() {
                        if (xhr.status === 0) {
                            xhr.abort();
                            reject('Server not found');
                            return;
                        }
                        
                        if (xhr.readyState === 4)   {
//                            if (xhr.status == 200) {
                                var resp = xhr.responseText;

                                try {
                                    resp = JSON.parse(xhr.responseText);
                                }
                                catch (e) {
                                }

                                xhr=null;
                                resolve(resp);
//                            }
//                            else {
//                                reject('Error status code: ' + xhr.status);
//                            }
                        }
                    }
                    xhr.send();
//                    xhr.send(JSON.stringify(data || {}));
                });
            };
        })();

        function ajaxJ(url, data) {
            return new Promise(function (resolve, reject) {
                $.ajax(url, {
    //                type: (url.indexOf('/delay') === 0) ? 'POST' : 'GET',
                    type: 'GET',
    //                contentType: 'application/json; charset=utf-8',
    //                data: JSON.stringify(data)
                })
                .done(resolve)
                .fail(resolve)
                .always(resolve);
            });
        }
        function ajaxF(url, data) {
            return fetch(url//, {
//                method: (url.indexOf('/delay') === 0) ? 'POST' : 'GET',
                //method: 'GET',
//                headers: new Headers({
////                    'Content-type' : 'application/json; charset=utf-8'
//                }),
//                body: JSON.stringify(data)
            //}
            );
        }

        var ajaxD = (function () {

            var lib = function (delay) {

                (typeof delay === 'undefined') && (delay = 100);

                return new Promise(function (resolve) {
                    setTimeout(resolve, delay);
                });
            };

            lib.reject = function (delay) {

                (typeof delay === 'undefined') && (delay = 100);

                return new Promise(function (resolve, reject) {
                    setTimeout(reject, delay);
                });
            }

            return lib;
        }());

        document.addEventListener('DOMContentLoaded', function () {

            var pre = (function () {
                var el = document.getElementById('json');
                var stack = [];
                el.innerHTML = location.origin + el.innerHTML;
                return function (obj) {
                    stack.push(obj)
                    el.innerHTML = JSON.stringify(stack, null, '    ');
                }
            }());

            var other = (function () {
                var el = document.getElementById('other');
                var data = {};
                var ret = function (key, val) {
                    data[key] = val;
                    el.innerHTML = JSON.stringify(data, null, '    ');
                }

                ret.data = function () {
                    return data;
                }

                return ret;
            }());

            var now = function () {
                return (new Date()).getTime();
            };

            other('start', now());

            // run only in browser
//            if (!window.__nightmare) {
                log('initialize in browser before');
                window.XMLHttpRequest.prototype.onAllFinished(null, null, true/* default values */).then(function (status) {
                    log('calculating diff', status);
                    var n = now();
                    other('onAllFinished', n);
                    other('diff', n - other.data().start);
                });
//            }

            var query = (function () {
                var t, tmp = {};
                location.search.replace(/^\?(.*)$/, '$1').split(/&/g).map(function (a) {
                    t = a.match(/^([^=]*)(?:=(.*))?$/);
                    t[2] = t[2] ? decodeURIComponent(t[2]) : true;

                    if (typeof tmp[t[1]] === 'undefined') {
                        tmp[t[1]] = [];
                    }

                    tmp[t[1]].push(t[2]);
                });
                return tmp;
            }());

            if (query.tape) {

                query.tape.forEach(function (tape) {

                    ajaxN('/test/ajax/' + tape + '.txt')
                        .then(function (data) {

                            data = data.split(/\n/g).filter(function (d) {
                                return !!trim(d);
                            }).map(function (d, t, i) {
                                t = {}, i = 0;
                                d.replace(/([^\s]+)/g, function (r) {
                                    t[(i++ === 0) ? 'm' : 'u'] = (/^\d+$/.test(r) ? parseInt(r, 10) : r);
                                });
                                return t;
                            });

                            (function run(t, m, u) {

                                t = data.shift();

                                if (t) {

                                    m = 'ajax' + t.m.toUpperCase();

                                    u = t.u;

                                    if (typeof u === 'string') {

                                        u += ((u.indexOf('?') > -1 ) ? '&' : '?' ) + m;
                                    }

                                    pre(t);

                                    window[m](u).then(run, run);
                                }
                            }());

                        });
                });
            }
        });

    </script>
</body>
</html>