<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Ajax</title>
</head>
<body>

    <button id="ajax">moreajax</button>
    <button id="fetch">fetch</button>
    <button id="ajaxwrong">ajaxwrong</button>
    <button id="fetchwrong">fetchwrong</button>
    <pre></pre>

    <script src="/libs/onAllFinished.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script>
//        window.XMLHttpRequest.prototype.onAllFinished(function (status) {
//            log('onAllFinished', status)
//        }, 1000, 3000);

        var log = (function () {try {return console.log;}catch (e) {return function () {}}}());

        var ajaxNative = (function () {
            function createXHR() {
                if (window.XDomainRequest) return new XDomainRequest();     // code for IE7+, Firefox, Chrome, Opera, Safari
                if (window.XMLHttpRequest) return new XMLHttpRequest();     // code for IE7+, Firefox, Chrome, Opera, Safari
                if (window.ActiveXObject)  return new ActiveXObject("Microsoft.XMLHTTP");  //   code for IE6, IE5
                throw "Can't create xhr object";
            };
            return function (url, data, fn, errfn) { // https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS
                data || (data = {});
                errfn || (errfn = function (e) {log(e)})
                var xhr  = createXHR();
                xhr.open('GET', url, true);
                xhr.setRequestHeader('Content-type', 'text/plain'); // for ie9 issue
                xhr.onreadystatechange = function() {
                    if (xhr.status === 0) {
                        xhr.abort();
                        errfn && errfn('Server not found');
                        return;
                    }
                    if (xhr.readyState == 4)   {
                        if (xhr.status  == 200) {
                            try {
                                var resp = JSON.parse(xhr.responseText);
                            }
                            catch (e) {
                                throw e;
                            }
                            fn && fn(resp);
                            xhr=null;
                        }
                        else {
                            errfn && errfn('Error status code: '+xhr.status);
                        }
                    }
                }
                xhr.send(JSON.stringify(data));
            };
        })();

        $(function () {
            var i = 0;

            var pre = document.querySelector('pre');

            function ajaxJQ(l, fn) {
                $.ajax('/json?_' + l)
                    .done(function (data) {
                        pre.innerHTML += l + "\n";
                        log(l, data);
                        fn && fn();
                    })
                ;
            }

            function ajaxN(l, fn) {
                ajaxNative('/json?_n_' + l, {}, function (data) {
                    log(l, data);
                    fn && fn();
                })
            }

            setTimeout(function () {

                ajaxJQ('a1', function () {
                    ajaxJQ('a2', function () {
                        ajaxJQ('a3', function () {
                            ajaxJQ('a4', function () {
                                setTimeout(function () {
                                    ajaxJQ('b1', function () {
                                        ajaxN('b2', function () {
                                            log('bx', i, ' end')
                                        });
                                    });
                                }, 300);
                            });
                        });
                    });
                });

                setTimeout(function () {
                    ajaxJQ('c1', function () {
                        ajaxJQ('c2', function () {
                            ajaxN('c3', function () {
                                ajaxN('c4', function () {
                                    log('cx_', i, ' end')
                                })
                            })
                        });
                    });
                }, 50)

            }, 500);

            (function () {

                var i = 0;

                $('#ajax').on('click', function () {
                    ajaxJQ('a1_'+i, function () {
                        ajaxJQ('a2_'+i, function () {
                            ajaxJQ('a3_'+i, function () {
                                ajaxJQ('a4_'+i, function () {
                                    setTimeout(function () {
                                        ajaxJQ('b1_'+i, function () {
                                            ajaxN('b2_'+i, function () {
                                                log('ax_', i, ' end')
                                            });
                                        });
                                    }, 300);
                                });
                            });
                        });
                    });
                    i += 1;
                });

                (function () {
                    var i = 0;
                    $('#ajaxwrong').on('click', function () {
                        ajaxNative('/ajaxwrong?_'+i)
                        i += 1;
                    })
                }())
            }());

            (function () {
                var i = 0;
                function fetchN(l, fn) {
                    var f = fetch('/json?fetch_' + l)

                    log('fetchN sent', l)
                    if (typeof fn === 'function') {
                        f.then(function (data) {
                            log(l)
                            fn && fn(data)
                        });
                    }
                }
                $('#fetch').on('click', function () {
                    fetchN('fetch1_' + i, function (data) {
                        fetchN('fetch2_' + i, function (data) {
                            fetchN('fetch3_' + i, function (data) {
                                fetchN('fetch4_' + i, function (data) {
                                    fetchN('fetch5_' + i, function (data) {
                                        fetchN('fetch6_' + i, function (data) {
                                            log('fetch_', i, ' end')
                                        });
                                    });
                                });
                            });
                        });
                    });
                    i += 1;
                });


                var wrong = function () {
                    fetch('/ajaxwrong?_fetch_'+i)
                };
                $('#fetchwrong').on('click', wrong);
//                wrong();
            }());

        });

    </script>
</body>
</html>